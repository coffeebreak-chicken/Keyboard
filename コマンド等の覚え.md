## 前提条件

- Docker Engine + Docker Compose(WSL2)
- WSL2 の準備("仮想マシン有効化"や"ubuntu インストール"など)

## 準備１ - wsl2 起動 -

### wsl2 の確認

- インストールしたディストリビューションの確認(パワーシェル上)
  - wsl --list --verbose

### wsl2 の確認

- docker をインストールしているか確認(Ubuntu ターミナル上)
  - docker -v
- apt パッケージの更新と、apt リポジトリを登録するために必要なパッケージのインストール
  - sudo apt update
  - sudo apt upgrade -y
  - sudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
    (参考：https://docs.docker.com/engine/install/ubuntu/)
- Docker の APT リポジトリ用の GPG 鍵をダウンロードして、指定の場所に保存する(APT が使える形式（バイナリ形式）に変換して保存)
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
- Docker の公式 GPG 鍵を追加
  - sudo chmod a+r /etc/apt/keyrings/docker.gpg
- 先程登録した GPG キーが正当なものであるかを fingerprint からチェック
  - ls -l /etc/apt/keyrings/
  - gpg --show-keys --fingerprint /etc/apt/keyrings/docker.gpg
    - pub rsa4096 2017-02-22 [SCEA]
    - 9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88
    - uid Docker Release (CE deb) <docker@docker.com>
    - sub rsa4096 2017-02-22 [S]
- docker リポジトリを追加(安定バージョン:stable)
  - echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
    $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
    sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
- リポジトリファイルの内容確認
  - cat /etc/apt/sources.list.d/docker.list
- 有効なリポジトリとして認識されているか確認
  - grep -r '^deb' /etc/apt/sources.list /etc/apt/sources.list.d/
- apt パッケージの更新
  - sudo apt update
- Docker パッケージをインストール(最新)
  - sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
- バージョン確認
  - docker --version
  - docker compose version
- サービスの状態を確認
  - service docker status
- 開始させる/終了させる
  - sudo service docker start
  - sudo service docker stop
- イメージを実行してインストールが成功したことを確認(hello-world)
  - sudo docker run hello-world

### ここまでの内容をエクスポート

- エクスポート用(バックアップ用)フォルダ作成(PowerShell 上)
  - cd /mnt/c/Users/Student
    　※バックアップ用なので c 配下
  - mkdir wsl_backups
  - cd ./wsl_backups
  - wsl --export Ubuntu-22.04 ./ubuntu_20250907.tar
- インポートしたい場合
  - wsl --import Ubuntu22.04 Ubuntu22.04 ubuntu_20250907.tar

### sudo 権限なしで Docker を実行できるようにユーザーを docker グループに追加

- sudo groupadd docker
- sudo usermod -aG docker $USER

## 準備２ - Ubuntu へ Docker Compose v2 インストール -

上記までの手順で docker をインストールすると、既に docker compose が使えるようになっています。
以下を実行してバージョンが表示されれば問題ありません。

$ docker compose version
Docker Compose version v2.18.1
※docker compose v2 になり、コマンドライン構文が「docker-compose」から「docker compose」に変更になっています。
以前からの docker-compose ユーザは戸惑うかもしれません。
参考：https://docs.docker.com/compose/migrate/

## QMK をクローンしてビルドする

- 出来たら公式の Dockerfile を使用

### wsl2 ホスト上でクローンする

- cd /home/student
- git clone --recurse-submodules https://github.com/qmk/qmk_firmware.git
- cd qmk_firmware

### docker_build.sh スクリプトの実行

- cd util/
- util/docker_build.sh <keyboard>:<keymap>
  - 例: util/docker_build.sh planck/rev6:default
    ※docker_build.sh スクリプトは、内部で qmk_cli イメージを利用
    ※内部で使用している qmk_cli イメージ：https://hub.docker.com/r/qmkfm/qmk_cli






### wsl2 ホスト上でクローンする
git clone --recurse-submodules https://github.com/vial-kb/vial-qmk





sudo service docker start
cd vial-qmk
util/docker_build.sh goforty_ortho:vial
sudo service docker stop
